# Fixed project name so all git worktrees share the same infra containers
# instead of each worktree creating its own set and causing port conflicts.
name: gram

services:
  gram-db:
    image: pgvector/pgvector:pg17
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-U", "${DB_USER}"]
      interval: 5s
      timeout: 5s
      retries: 5
  gram-cache:
    image: redis:6.2-alpine
    restart: unless-stopped
    volumes:
      - cache_data:/var/lib/gram-cache/data
    ports:
      - "${GRAM_REDIS_CACHE_ADDR}:35299"
    command: redis-server --port 35299 --requirepass xi9XILbY

  gram-temporal:
    image: temporalio/server:1.27.2
    restart: unless-stopped
    ports:
      - "${TEMPORAL_PORT}:7233"
      - "${TEMPORAL_WEB_PORT}:8233"
    entrypoint: ["temporal"]
    command:
      [
        "server",
        "start-dev",
        "--ip",
        "0.0.0.0",
        "--ui-ip",
        "0.0.0.0",
        "--namespace",
        "default",
        "--db-filename",
        "/home/temporal/dev.db",
      ]
    volumes:
      - temporal_data:/home/temporal
    healthcheck:
      test: ["CMD", "temporal", "operator", "cluster", "health"]
      interval: 5s
      timeout: 30s
      retries: 5

  oteltui:
    image: ymtdzzz/otel-tui@sha256:67010920b012ee998888cf39a794f32e97ca4b01cd02681f25e8f47c261e305b

    stdin_open: true
    tty: true
    ports:
      - "4317:4317"

  clickhouse:
    image: clickhouse/clickhouse-server:25.8.3
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
      - "9440:9440"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: gram
      CLICKHOUSE_PASSWORD: gram
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    mem_limit: 2g
    memswap_limit: 2g
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - ./local/clickhouse/config.d/config.xml:/etc/clickhouse-server/config.d/config.xml
      - ./local/clickhouse/config.d/limits.xml:/etc/clickhouse-server/config.d/limits.xml
      - ./local/clickhouse/config.d/ssl.xml:/etc/clickhouse-server/config.d/ssl.xml
      - ./local/clickhouse/users.d/dev_profile.xml:/etc/clickhouse-server/users.d/dev_profile.xml
      - ./local/clickhouse/certs:/etc/clickhouse-server/certs:ro
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  mcp-registry-db:
    profiles: [local-registry]
    image: postgres:17
    restart: unless-stopped
    environment:
      POSTGRES_USER: mcp_registry
      POSTGRES_PASSWORD: mcp_registry
      POSTGRES_DB: mcp_registry
    volumes:
      - mcp_registry_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-U", "mcp_registry"]
      interval: 5s
      timeout: 5s
      retries: 5
  mcp-registry:
    profiles: [local-registry]
    image: ghcr.io/modelcontextprotocol/registry:1.3.10
    restart: unless-stopped
    environment:
      MCP_REGISTRY_DATABASE_URL: postgresql://mcp_registry:mcp_registry@mcp-registry-db:5432/mcp_registry
      MCP_REGISTRY_JWT_PRIVATE_KEY: ffb75d70bdacadee50324c5f93b04e5674b1df37b4e234e603e5c08500eb0740
      MCP_REGISTRY_ENABLE_ANONYMOUS_AUTH: "true"
    ports:
      - "${LOCAL_MCP_REGISTRY_PORT}:8080"
    depends_on:
      mcp-registry-db:
        condition: service_healthy

volumes:
  postgres_data:
    driver: local
  cache_data:
    driver: local
  temporal_data:
    driver: local
  clickhouse_data:
    driver: local
  mcp_registry_data:
    driver: local
