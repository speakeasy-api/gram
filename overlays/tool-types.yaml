overlay: 1.0.0
x-speakeasy-jsonpath: rfc9535
info:
  title: Fix Tool discriminated union types
  version: 0.0.0
actions:
  # Remove ListToolsResult2 schema
  - target: $.components.schemas.ListToolsResult2
    remove: true

  # Remove default Tool schema (Goa's custom union encoding)
  - target: $.components.schemas.Tool.properties
    remove: true

  # Replace Tool with proper oneOf discriminated union
  - target: $.components.schemas.Tool
    update:
      description: A polymorphic tool - can be an HTTP tool or a prompt template
      oneOf:
        - $ref: "#/components/schemas/HTTPToolDefinition"
        - $ref: "#/components/schemas/PromptTemplate"
      discriminator:
        propertyName: type
        mapping:
          http: "#/components/schemas/HTTPToolDefinition"
          prompt: "#/components/schemas/PromptTemplate"

  # Ensure listTools endpoint returns ListToolsResult (not ListToolsResult2)
  - target: $.paths['/rpc/tools.list'].get.responses['200'].content['application/json'].schema
    update:
      $ref: "#/components/schemas/ListToolsResult"

  # Ensure ListToolsResult references Tool (not the removed Tool2)
  - target: $.components.schemas.ListToolsResult.properties.tools.items
    update:
      $ref: "#/components/schemas/Tool"

  # Add tool_type field to HTTPToolDefinition for discriminator
  - target: $.components.schemas.HTTPToolDefinition.properties
    update:
      type:
        type: string
        description: The type of the tool - discriminator value
        enum:
          - http

  # Add tool_type field to PromptTemplate for discriminator
  - target: $.components.schemas.PromptTemplate.properties
    update:
      type:
        type: string
        description: The type of the tool - discriminator value
        enum:
          - prompt

  # Replace GetInstanceResult2 with GetInstanceResult
  - target: $.components.schemas.GetInstanceResult2
    remove: true
  - target: $.paths['/rpc/instances.get'].get.responses['200'].content['application/json'].schema
    update:
      $ref: "#/components/schemas/GetInstanceResult"

  # Remove ToolX schemas using search on key names
  - target: $.components.schemas[?search(@~, 'Tool[0-9]+')]
    remove: true

  # Remove ToolsetX schemas using search on key names
  - target: $.components.schemas[?search(@~, 'Toolset[0-9]+')]
    remove: true

  # Replace all references to ToolX with Tool using regex match (anchored to match exact pattern)
  - target: $..[?match(@['$ref'], '^#/components/schemas/Tool[0-9]+$')]['$ref']
    update: "#/components/schemas/Tool"

  # Replace all references to ToolsetX with ToolsetEntry using regex match (anchored to match exact pattern)
  - target: $..[?match(@['$ref'], '^#/components/schemas/Toolset[0-9]+$')]['$ref']
    update: "#/components/schemas/Toolset"
