-- ClickHouse Queries for Telemetry
--
-- NOTE: These queries are NOT auto-generated by sqlc (sqlc doesn't support ClickHouse).
-- However, we follow sqlc conventions for consistency with the rest of the codebase.
--
-- To add a new query:
-- 1. Add the query here with sqlc-style comments (-- name: FunctionName :many/:one/:exec)
-- 2. Manually implement the corresponding function in queries.sql.go
-- 3. Follow the patterns established in this file for parameter passing and result handling
--
-- Ask Claude Code to generate the Go implementation - it will follow these conventions.

-- name: ListToolLogs :many
-- Lists tool logs from the tool_logs table with pagination and filtering.
-- Uses cursor-based pagination with UUIDv7 timestamps for efficient querying.
select
	id,
	timestamp,
	instance,
	level,
	source,
	raw_log,
	message,
	toString(attributes) as attributes,
	project_id,
	deployment_id,
	function_id
from tool_logs
where project_id = ?
	and timestamp >= ?
	and timestamp <= ?
	and (? = '' or deployment_id = ?)
	and (? = '' or function_id = ?)
	and (? = '' or instance = ?)
	and (? = '' or level = ?)
	and (? = '' or source = ?)
	-- Cursor-based pagination using the nil UUID (00000000-0000-0000-0000-000000000000) as a sentinel
	-- value to indicate "no cursor" (first page). This is necessary because ClickHouse doesn't support
	-- short-circuit evaluation in OR expressions - it would try to parse an empty string as a UUID.
	-- The IF function provides conditional evaluation: skip cursor filtering on first page, otherwise
	-- filter by timestamp extracted from the UUIDv7 cursor (which embeds creation time).
	and if(
		toUUID(?) = toUUID('00000000-0000-0000-0000-000000000000'),
		true,
		if(? = 'ASC', timestamp > UUIDv7ToDateTime(toUUID(?)), timestamp < UUIDv7ToDateTime(toUUID(?)))
	)
order by
	case when ? = 'ASC' then timestamp end asc,
	case when ? = 'DESC' then timestamp end desc
limit ?;
