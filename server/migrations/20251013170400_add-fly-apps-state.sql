-- Modify "deployments_functions" table
ALTER TABLE "deployments_functions" ADD COLUMN "runner_version" text NULL;
-- Modify "projects" table
ALTER TABLE "projects" ADD COLUMN "functions_runner_version" text NULL;
-- Create "fly_apps" table
CREATE TABLE "fly_apps" ("id" uuid NOT NULL DEFAULT generate_uuidv7(), "seq" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY, "project_id" uuid NOT NULL, "deployment_id" uuid NOT NULL, "function_id" uuid NOT NULL, "access_id" uuid NOT NULL, "fly_org_id" text NOT NULL, "fly_org_slug" text NOT NULL, "app_name" text NOT NULL, "app_url" text NOT NULL, "runner_version" text NOT NULL, "primary_region" text NOT NULL, "status" text NOT NULL, "reaped_at" timestamptz NULL, "created_at" timestamptz NOT NULL DEFAULT clock_timestamp(), "updated_at" timestamptz NOT NULL DEFAULT clock_timestamp(), PRIMARY KEY ("id"), CONSTRAINT "fly_apps_access_id_fkey" FOREIGN KEY ("access_id") REFERENCES "functions_access" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "fly_apps_deployment_id_fkey" FOREIGN KEY ("deployment_id") REFERENCES "deployments" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "fly_apps_function_id_fkey" FOREIGN KEY ("function_id") REFERENCES "deployments_functions" ("id") ON UPDATE NO ACTION ON DELETE CASCADE, CONSTRAINT "fly_apps_project_id_fkey" FOREIGN KEY ("project_id") REFERENCES "projects" ("id") ON UPDATE NO ACTION ON DELETE CASCADE);
-- Create index "fly_apps_access_id_idx" to table: "fly_apps"
CREATE INDEX "fly_apps_access_id_idx" ON "fly_apps" ("access_id" DESC);
-- Create index "fly_apps_project_deployment_function_key" to table: "fly_apps"
CREATE UNIQUE INDEX "fly_apps_project_deployment_function_key" ON "fly_apps" ("project_id", "deployment_id", "function_id", "status");
-- Create index "fly_apps_seq_key" to table: "fly_apps"
CREATE UNIQUE INDEX "fly_apps_seq_key" ON "fly_apps" ("seq" DESC);
