-- atlas:txmode none
-- atlas:nolint MF104

-- Modify "chat_messages" table - add column as nullable bigint first
ALTER TABLE "chat_messages" ADD COLUMN "seq" bigint;

-- Backfill seq values based on id order (UUIDv7 is chronologically sorted)
WITH ranked_messages AS (
  SELECT id, ROW_NUMBER() OVER (ORDER BY id) AS row_num
  FROM chat_messages
)
UPDATE chat_messages
SET seq = ranked_messages.row_num
FROM ranked_messages
WHERE chat_messages.id = ranked_messages.id;

-- Convert to identity column
ALTER TABLE "chat_messages" ALTER COLUMN "seq" SET NOT NULL;
ALTER TABLE "chat_messages" ALTER COLUMN "seq" ADD GENERATED BY DEFAULT AS IDENTITY;

-- Create unique index concurrently to avoid ACCESS EXCLUSIVE lock (PG105)
CREATE UNIQUE INDEX CONCURRENTLY "chat_messages_seq_key" ON "chat_messages" ("seq");
-- Promote the index to a proper unique constraint
ALTER TABLE "chat_messages" ADD CONSTRAINT "chat_messages_seq_key" UNIQUE USING INDEX "chat_messages_seq_key";

-- Update the sequence to start after the highest current value
SELECT setval(pg_get_serial_sequence('chat_messages', 'seq'), (SELECT GREATEST(COALESCE(MAX(seq), 0), 1) FROM chat_messages));
