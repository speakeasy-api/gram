name: Release Gram CLI
on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
permissions:
  contents: write
jobs:
  release:
    name: Release Gram CLI
    # NOTE(cjea): Using Windows runner for future Chocolatey/Winget
    # compatibility.
    runs-on: windows-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Setup environment
        run: |-
          chcp 65001 #set code page to utf-8
      - name: Checkout repository
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0
        with:
          fetch-depth: 0
      - name: Check if CLI was released
        id: check-release
        shell: pwsh
        run: |
          $tag = git tag --points-at HEAD | Select-String -Pattern "^@gram/cli@"
          if ($tag) {
            echo "released=true" >> $env:GITHUB_OUTPUT
            echo "CLI release tag found: $tag"
          } else {
            echo "released=false" >> $env:GITHUB_OUTPUT
            echo "No CLI release tag found at HEAD"
          }
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        if: steps.check-release.outputs.released == 'true'
        with:
          go-version-file: "cli/go.mod"
          # Reference: https://github.com/actions/setup-go/issues/495
          cache: false
      - name: Setup Choco
        if: steps.check-release.outputs.released == 'true'
        uses: crazy-max/ghaction-chocolatey@2526f467ccbd337d307fe179959cabbeca0bc8c0 # v3.4.0
        with:
          args: --version
      - name: Generate GitHub App Token for Gram Bot
        if: steps.check-release.outputs.released == 'true'
        id: bot-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GRAM_BOT_APP_ID }}
          private-key: ${{ secrets.GRAM_BOT_PRIVATE_KEY }}
          owner: speakeasy-api
          repositories: gram,homebrew-tap
      - name: goreleaser
        if: steps.check-release.outputs.released == 'true'
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser-pro
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ steps.bot-token.outputs.token }}
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
          GORELEASER_KEY: ${{secrets.GORELEASER_PRO_LICENSE_KEY}}
