name: Elements E2E Tests

on:
  pull_request:
    branches:
      - main
    paths:
      - "elements/**"

permissions:
  contents: read

jobs:
  e2e:
    name: Playwright E2E Tests
    runs-on: ubicloud-standard-4
    steps:
      - name: Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v5.0.0

      - name: Setup Mise
        uses: jdx/mise-action@c53b9236f0b3370f31520f8b142f141256d839c6 # v3.6.0
        with:
          install: true
          cache: true
          env: false

      - name: Prepare GitHub Actions environment
        run: mise run github

      - name: Cache PNPM
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          key: ${{ env.GH_CACHE_PNPM_KEY }}
          restore-keys: |
            ${{ env.GH_CACHE_PNPM_KEY }}
            ${{ env.GH_CACHE_PNPM_KEY_PARTIAL }}
          path: |
            ${{ env.PNPM_STORE_PATH }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        working-directory: elements

      - name: Run Playwright tests
        run: pnpm test:e2e
        working-directory: elements

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: playwright-report
          path: elements/playwright-report/
          retention-days: 7

      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results
          path: elements/test-results/
          retention-days: 7

      - name: Prune PNPM store
        if: success()
        run: pnpm store prune
