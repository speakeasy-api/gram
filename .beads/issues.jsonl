{"id":"gram-01o","title":"Add ProxyToolExecutor to externalmcp package","description":"## Summary\nCreate a new ProxyToolExecutor type in the externalmcp package that consolidates the duplicated logic for interacting with external MCP servers across three code paths:\n- gateway/proxy.go:doExternalMCP\n- mcp/rpc_tools_list.go:unfoldExternalMCPTools  \n- mcp/rpc_tools_call.go:handleExternalMCPToolCall\n\n## Design Philosophy\nThe executor should be a **low-level abstraction** that:\n- Takes a complete proxy tool definition (static config)\n- Takes pre-resolved runtime auth/headers\n- Connects to an external MCP server\n- Provides DoList and DoCall operations\n- Leaves env var resolution and slug prefix filtering to callers\n\n## Types\n\n### HeaderDefinition\n```go\ntype HeaderDefinition struct {\n    Name       string  // Prefixed env var name (e.g., \"SLACK_X_API_KEY\")\n    HeaderName string  // HTTP header to send (e.g., \"X-Api-Key\")\n}\n```\n\n### ProxyToolConfig\n```go\ntype ProxyToolConfig struct {\n    RemoteURL         string\n    Slug              string\n    TransportType     types.TransportType\n    RequiresOAuth     bool\n    HeaderDefinitions []HeaderDefinition  // Already filtered to this proxy tool\n}\n```\n\n### ProxyToolAuth  \n```go\ntype ProxyToolAuth struct {\n    OAuthToken string              // OAuth token (becomes \"Bearer \u003ctoken\u003e\")\n    Headers    map[string]string   // Pre-resolved HTTP headers\n}\n```\n\n### ProxyToolExecutor\n```go\nfunc NewProxyToolExecutor(ctx, logger, config *ProxyToolConfig, auth *ProxyToolAuth) (*ProxyToolExecutor, error)\nfunc (e *ProxyToolExecutor) DoList(ctx) ([]Tool, error)\nfunc (e *ProxyToolExecutor) DoCall(ctx, toolName string, arguments json.RawMessage) (*CallToolResult, error)\nfunc (e *ProxyToolExecutor) Close() error\nfunc (e *ProxyToolExecutor) Slug() string\n```\n\n## Helper Functions\n\n### ResolveProxyAuth\nResolves env vars to headers using config's HeaderDefinitions:\n```go\nfunc ResolveProxyAuth(\n    config *ProxyToolConfig,\n    baseEnv map[string]string,  // Keys may be mixed case\n    userEnv map[string]string,  // Keys may be mixed case\n    oauthToken string,\n) *ProxyToolAuth\n```\n\n### FilterHeaderDefinitionsBySlug (for MCP path)\nFilters toolset-level header definitions to those matching a specific slug:\n```go\nfunc FilterHeaderDefinitionsBySlug(\n    defs []*types.ExternalMCPHeaderDefinition,\n    slug string,\n) []HeaderDefinition\n```\n\n## Data Flow Analysis\n\n### Gateway Path (doExternalMCP)\n```\nInput:\n  plan *ExternalMCPToolCallPlan\n    .RemoteURL, .Slug, .TransportType, .RequiresOAuth\n    .HeaderDefinitions []ExternalMCPHeaderDef  \u003c- Already scoped to this tool\n  env ToolCallEnv\n    .SystemEnv  *CaseInsensitiveEnv\n    .UserConfig *CaseInsensitiveEnv\n\nTransform:\n  config := \u0026ProxyToolConfig{\n      RemoteURL:     plan.RemoteURL,\n      Slug:          plan.Slug,\n      TransportType: plan.TransportType,\n      RequiresOAuth: plan.RequiresOAuth,\n      HeaderDefinitions: directConvert(plan.HeaderDefinitions),\n  }\n  auth := ResolveProxyAuth(config,\n      env.SystemEnv.All(),\n      env.UserConfig.All(),\n      env.UserConfig.Get(ExternalMCPOAuthTokenKey))\n```\n\n### MCP Path (unfoldExternalMCPTools, handleExternalMCPToolCall)\n```\nInput:\n  tool *types.ExternalMCPToolDefinition\n    .RemoteURL, .Slug, .TransportType, .RequiresOauth\n  headerDefs []*types.ExternalMCPHeaderDefinition  \u003c- ALL sources, needs filtering\n  storedEnvVars map[string]string  \u003c- From env.Load() if authenticated\n  payload.mcpEnvVariables map[string]string\n  payload.oauthTokenInputs []oauthTokenInput\n\nTransform:\n  config := \u0026ProxyToolConfig{\n      RemoteURL:     tool.RemoteURL,\n      Slug:          tool.Slug,\n      TransportType: types.TransportType(tool.TransportType),\n      RequiresOAuth: tool.RequiresOauth,\n      HeaderDefinitions: FilterHeaderDefinitionsBySlug(headerDefs, tool.Slug),\n  }\n  auth := ResolveProxyAuth(config,\n      storedEnvVars,\n      payload.mcpEnvVariables,\n      extractOAuthToken(payload.oauthTokenInputs))\n```\n\n## Files to Modify\n- NEW: server/internal/externalmcp/proxytoolexecutor.go\n- server/internal/gateway/proxy.go - refactor doExternalMCP\n- server/internal/mcp/rpc_tools_list.go - refactor unfoldExternalMCPTools\n- server/internal/mcp/rpc_tools_call.go - remove handleExternalMCPToolCall\n\n## Acceptance Criteria\n- [ ] ProxyToolConfig/ProxyToolAuth/ProxyToolExecutor types created\n- [ ] ResolveProxyAuth consolidates header merging logic\n- [ ] FilterHeaderDefinitionsBySlug extracts slug-scoped headers\n- [ ] doExternalMCP refactored to use ProxyToolExecutor\n- [ ] unfoldExternalMCPTools refactored to use ProxyToolExecutor\n- [ ] handleExternalMCPToolCall removed entirely\n","status":"closed","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-22T16:00:38.117286-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-22T17:56:40.438599-08:00","closed_at":"2026-01-22T17:56:40.438599-08:00","close_reason":"ProxyToolExecutor implemented and all three code paths refactored"}
{"id":"gram-03i","title":"Add changes to store Header schemas from MCP Registry","description":"## Summary\nStore and apply header configurations for external MCP servers from the registry.\n\n## Implementation Details\n\n### Schema Changes\n- Added `external_mcp_header_definitions` table to store header schemas per external MCP source\n- Each header definition has: `name` (env var name), `header_name` (HTTP header), `description`, `required`\n\n### Env Var Prefixing\nHeaders are matched to their external MCP source via slug-based prefixing:\n- Header env var names are normalized and prefixed with the source slug (e.g., `SLACK_API_KEY` for slug `slack`)\n- Matching logic in `unfoldExternalMCPTools` filters header definitions by `slugPrefix`\n- Values can come from stored environment or user-provided `mcpEnvVariables`, with user values taking precedence\n\n### Header Application\n- Headers are passed to `externalmcp.ClientOptions` and applied via `authRoundTripper`\n- Supports both OAuth bearer tokens and custom headers simultaneously","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-18T11:32:54.153074-08:00","updated_at":"2026-01-16T09:38:49.212078-08:00","dependencies":[{"issue_id":"gram-03i","depends_on_id":"gram-mbw","type":"blocks","created_at":"2026-01-13T21:20:29.283402-08:00","created_by":"quinn"}]}
{"id":"gram-162","title":"OAuth provider constraint - enforce single per toolset","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-18T11:32:58.990565-08:00","updated_at":"2025-12-18T11:32:58.990565-08:00"}
{"id":"gram-1e2","title":"Publish Project as Sub-Registry","description":"Add registry_enabled flag to projects. Add handler to mcpregistries package: GET /{org}/{project}/v0.1/servers. Handler serves registry-compliant JSON listing project toolsets as servers. Include PulseMCP-compatible _meta annotations.\n\nUse case: Fill gaps in available servers by publishing Gram Functions as MCP servers.\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-20T10:33:10.405999-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:22.895526-08:00","labels":["triage"]}
{"id":"gram-1x1","title":"User Views Project Toolsets","description":"Project landing page shows toolset summary cards. Toolset cards display tool counts and descriptions. User sees only project-scoped toolsets, not full registry.\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:32:57.615068-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:22.84244-08:00","labels":["triage"],"dependencies":[{"issue_id":"gram-1x1","depends_on_id":"gram-pri","type":"blocks","created_at":"2026-01-21T10:55:04.623321-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-21w","title":"Get Georges to review oauthdiscovery.go","description":"Need Georges' help reviewing server/internal/externalmcp/oauthdiscovery.go\n\nThis file handles OAuth metadata discovery for external MCP servers:\n- Parses WWW-Authenticate headers\n- Fetches RFC 8414 (AS metadata) and RFC 9728 (protected resource metadata)\n- Determines OAuth version (2.1 vs 2.0) based on registration endpoint presence\n- Probes well-known locations when headers don't provide URLs\n\nWould like Georges to review the OAuth flow and ensure it's correct.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-19T15:17:58.653356-08:00","updated_at":"2026-01-20T10:32:33.10988-08:00","closed_at":"2026-01-20T10:32:33.10988-08:00","close_reason":"Won't do / out of scope"}
{"id":"gram-2ij","title":"Proxy Headers from External MCP to Final Config","description":"## Summary\n\nProxy header requirements from external MCP server metadata through to the final MCP server configuration, enabling users to configure required headers (API keys, auth tokens) for external MCP servers.\n\n## Branch\n\n`external-mcp/add-header-configuration` - contains bulk of implementation\n\n## Current Implementation\n\n### Schema\n- Added `header_definitions JSONB` column to `external_mcp_tool_definitions`\n\n### Registry Parsing\n- `registryclient.go`: Parses `remotes[].headers` from registry response\n- Each header has: `name`, `isSecret`, `isRequired`, `description`, `placeholder`\n\n### API Surface\n- `ExternalMCPHeaderDefinition` type exposed on toolset responses\n- Fields: `name` (prefixed env var), `header_name` (HTTP header), `required`, `secret`, `description`, `placeholder`\n- Env var naming: `{SLUG}_{HEADER_NAME}` in SCREAMING_SNAKE_CASE\n\n### Runtime\n- `gateway/proxy.go`: Reads header values from SystemEnv (base) with UserConfig overrides\n- Passes headers to external MCP client at tool call time\n\n## Remaining Work\n\n### 1. Refactor Header Grouping by Source\n\nExtract header parsing logic so that `mcpPayload` receives headers **pre-separated by source**. Currently the external MCP processing code has to filter through all user variables to find ones matching its prefix. Instead:\n\n- Headers should be grouped by source slug before reaching the external MCP handler\n- External MCP processing code receives only the headers relevant to its source\n- Eliminates prefix-matching logic at call time\n\n### 2. OAuth → Authorization Header\n\nWhen OAuth is detected during deployment processing, generate an `Authorization` header definition:\n- Name: `{SLUG}_AUTHORIZATION`\n- HeaderName: `Authorization`  \n- Required: true (since OAuth is required)\n- Secret: true\n- Description: \"Bearer token for OAuth authentication\"\n\nThis allows OAuth tokens to flow through the same header mechanism.\n\n### 3. Verify Install UI\n\nConfirm that `ExternalMCPHeaderDefinition` surfaces correctly in the install flow:\n- Required vs optional indicators\n- Secret field masking\n- Placeholder hints\n\n## Files Changed (branch)\n\n- `server/database/schema.sql` - header_definitions column\n- `server/internal/externalmcp/registryclient.go` - header parsing\n- `server/internal/background/activities/process_deployment.go` - store headers\n- `server/internal/toolsets/shared.go` - extract headers for tool call plan\n- `server/internal/gateway/proxy.go` - pass headers at runtime\n- `server/internal/mv/toolset.go` - expose in API\n- `server/design/shared/toolset.go` - Goa types\n\n## Acceptance Criteria\n\n- [ ] Headers from registry `remotes[].headers` are stored and surfaced\n- [ ] OAuth-requiring servers generate an Authorization header definition\n- [ ] Headers are pre-grouped by source in mcpPayload (no prefix filtering at call time)\n- [ ] Headers appear in toolset API responses with correct prefixed names\n- [ ] Headers are passed to external MCP servers at tool call time\n- [ ] Install UI shows header requirements (verify)\n","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:24.294988-08:00","created_by":"quinn","updated_at":"2026-01-22T16:02:48.539403-08:00","labels":["triage"],"dependencies":[{"issue_id":"gram-2ij","depends_on_id":"gram-01o","type":"blocks","created_at":"2026-01-22T16:02:48.714713-08:00","created_by":"Quinn Stearns"},{"issue_id":"gram-2ij","depends_on_id":"gram-3gg","type":"blocks","created_at":"2026-01-25T15:50:31.809605-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-3bn","title":"Project-Level Group Install Page","description":"Create project-level install page/modal extending hosted_page.html.tmpl pattern. Generate aggregated install commands for multiple toolsets. Handle multiple MCP server URLs in single install flow.\n\nThis is the PRIMARY value delivery for the Fivetran demo.\n\nSee gram-9r1 for full context.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-20T10:33:03.495065-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:22.788091-08:00","labels":["triage"]}
{"id":"gram-3gg","title":"Test and validate header proxying","description":"Manually test and validate that headers are being properly proxied through to external MCP servers.\n\n## Test scenarios\n- Headers defined in registry metadata are passed through\n- SystemEnv values are resolved correctly\n- UserConfig values override SystemEnv\n- Multiple headers work correctly\n\nParent: gram-2ij","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-25T15:50:20.690646-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-25T15:50:20.690646-08:00"}
{"id":"gram-3k4","title":"Render updated_at date from source card in sources UI","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-18T11:46:35.791947-08:00","updated_at":"2026-01-20T10:32:33.106499-08:00","closed_at":"2026-01-20T10:32:33.106499-08:00","close_reason":"Won't do / out of scope"}
{"id":"gram-4vt","title":"Align Import MCP tab behavior with catalog","description":"The 'Import MCP' tab in the add source dialog should behave the same as adding an MCP from the catalog.\n\n## Current Behavior\n- Import MCP tab has different behavior/flow than catalog selection\n\n## Desired Behavior  \n- Both paths should have consistent UX\n- Import MCP tab should match the catalog's add flow","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-18T18:42:39.245016-08:00","updated_at":"2025-12-18T18:42:39.245016-08:00"}
{"id":"gram-511","title":"Drop SSE transport support","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-18T11:33:16.908855-08:00","updated_at":"2026-01-20T10:32:33.111161-08:00","closed_at":"2026-01-20T10:32:33.111161-08:00","close_reason":"Won't do / out of scope"}
{"id":"gram-52s","title":"Refactor external MCP OAuth architecture","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T11:33:01.290945-08:00","updated_at":"2025-12-18T11:33:01.290945-08:00"}
{"id":"gram-5h2","title":"Production Ready External MCP","status":"open","priority":0,"issue_type":"epic","created_at":"2025-12-18T11:31:50.817818-08:00","updated_at":"2025-12-18T11:31:50.817818-08:00","dependencies":[{"issue_id":"gram-5h2","depends_on_id":"gram-cpz","type":"blocks","created_at":"2025-12-18T11:33:33.812434-08:00","created_by":"daemon"},{"issue_id":"gram-5h2","depends_on_id":"gram-03i","type":"blocks","created_at":"2025-12-18T11:33:33.982835-08:00","created_by":"daemon"},{"issue_id":"gram-5h2","depends_on_id":"gram-x07","type":"blocks","created_at":"2025-12-18T11:33:34.146998-08:00","created_by":"daemon"},{"issue_id":"gram-5h2","depends_on_id":"gram-jt9","type":"blocks","created_at":"2025-12-18T11:46:47.849969-08:00","created_by":"daemon"},{"issue_id":"gram-5h2","depends_on_id":"gram-3k4","type":"blocks","created_at":"2025-12-18T11:46:48.015833-08:00","created_by":"daemon"},{"issue_id":"gram-5h2","depends_on_id":"gram-4vt","type":"blocks","created_at":"2025-12-18T18:42:47.92632-08:00","created_by":"daemon"}]}
{"id":"gram-5h2.1","title":"Respond to templated URL schemes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T14:10:16.548187-08:00","created_by":"quinn","updated_at":"2026-01-20T14:10:16.548187-08:00","dependencies":[{"issue_id":"gram-5h2.1","depends_on_id":"gram-5h2","type":"parent-child","created_at":"2026-01-20T14:10:16.54899-08:00","created_by":"quinn"}]}
{"id":"gram-5uo","title":"Use ProxyToolExecutor.MatchPlan in rpc_tools_call","description":"## Motivation\n\nMake `doExternalMCP` in `gateway/proxy.go` homogeneous for both proxy tools and materialized external MCP tools.\n\n## Current State\n\n- `ProxyToolExecutor.MatchPlan` exists but isn't consumed in the tool call path\n- `doExternalMCP` handles materialized tools but doesn't use `MatchPlan` for proxy tools\n\n## Implementation\n\nIn `rpc_tools_call.go` (or wherever tool calls are dispatched):\n\n1. Build `ProxyToolExecutor` from toolset's proxy tool definitions\n2. Call `executor.MatchPlan(ctx, toolName, projectID, resolve)`\n3. If match found → use the returned `ToolCallPlan` to call `doExternalMCP`\n4. If no match → fall through to existing materialized tool handling\n\nThis unifies the code path so `doExternalMCP` receives a `ToolCallPlan` regardless of whether the tool is a proxy or materialized.\n\n## Files\n\n- `server/internal/mcp/rpc_tools_call.go` - integrate `MatchPlan`\n- `server/internal/gateway/proxy.go` - verify `doExternalMCP` works for both cases","status":"closed","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-26T11:47:10.349112-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-26T14:30:50.746047-08:00","closed_at":"2026-01-26T14:30:50.746047-08:00","close_reason":"Implemented MatchPlanInputs integration in rpc_tools_call.go. ProxyToolExecutor now filters proxy tools internally and MatchPlanInputs is called before the materialized tool loop."}
{"id":"gram-60v","title":"Implement Sub Catalog Wizard that Creates New Project","description":"AGE-1128: Main workflow for creating sub-catalogs","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T10:40:01.49759-08:00","created_by":"quinn","updated_at":"2026-01-12T10:40:01.49759-08:00","dependencies":[{"issue_id":"gram-60v","depends_on_id":"gram-9r1","type":"blocks","created_at":"2026-01-12T10:41:25.800146-08:00","created_by":"quinn"},{"issue_id":"gram-60v","depends_on_id":"gram-zui","type":"blocks","created_at":"2026-01-12T10:41:34.658659-08:00","created_by":"quinn"}]}
{"id":"gram-6tq","title":"Rename registry_name to source_name in tools design","description":"PR feedback from qstearns: Consider renaming the field to `source_name` instead of using a registry prefix, since the name isn't meaningful in the context of the registry itself.\n\nLocation: server/design/shared/tools.go:115\n\nReference: https://github.com/speakeasy-api/gram/pull/1328#discussion","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-22T22:38:26.242348-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-22T22:38:26.242348-08:00"}
{"id":"gram-6w9","title":"Resources support - attempt calling list_resources","status":"open","priority":4,"issue_type":"feature","created_at":"2025-12-18T11:33:14.786967-08:00","updated_at":"2025-12-18T11:33:14.786967-08:00","labels":["triage"]}
{"id":"gram-78g","title":"Support legacy OAuth 2.0 external MCP servers","description":"## Context\n\nExternal MCP servers like GitHub use legacy OAuth 2.0 without RFC 8414 Authorization Server Metadata discovery. This means they don't expose a `.well-known/oauth-authorization-server` endpoint and require static client registration.\n\nCurrently, deployment processing fails for these servers with the message: \"external MCP server uses legacy OAuth 2.0 which requires static client registration; dynamic client registration is not supported\"\n\n## MVP: Header-Based Bearer Token Auth\n\nThe simplest solution is to allow users to configure a static Bearer token that gets injected into requests to the external MCP server.\n\n1. Add configuration for a Bearer token on external MCP attachments\n2. Inject the token in the Authorization header when proxying requests\n3. Skip OAuth flow entirely for servers with pre-configured tokens\n\n## Future Work\n\n- Full OAuth 2.0 flow with static client credentials (client_id/client_secret)\n- Token refresh support for long-lived sessions\n\n## Related Files\n\n- server/internal/externalmcp/oauthdiscovery.go\n- server/internal/background/activities/process_deployment.go\n","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-18T17:42:17.939181-08:00","updated_at":"2025-12-18T17:42:17.939181-08:00","labels":["triage"]}
{"id":"gram-7y8","title":"Better empty state for catalog","status":"open","priority":4,"issue_type":"feature","created_at":"2025-12-18T11:33:11.955685-08:00","updated_at":"2025-12-18T11:33:11.955685-08:00"}
{"id":"gram-85i","title":"Tag Chase on gram-rtt for product decision on duplicate handling","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T13:40:33.84293-08:00","updated_at":"2025-12-22T13:40:33.84293-08:00","dependencies":[{"issue_id":"gram-85i","depends_on_id":"gram-rtt","type":"blocks","created_at":"2025-12-22T13:41:00.729501-08:00","created_by":"daemon"}]}
{"id":"gram-90c","title":"External MCP tools in Playground","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-18T11:32:26.921845-08:00","updated_at":"2025-12-18T11:32:26.921845-08:00"}
{"id":"gram-9r1","title":"Prepare Fivetran Demo","description":"# Sub-Catalog Management for Enterprise Partners\n\n## Overview\n\nThis epic defines the requirements for enabling enterprise partners (like Fivetran) to create and manage **sub-catalogs** - curated collections of MCP servers that they can offer to their end users through Gram.\n\n---\n\n## Key Terms \u0026 System Resources\n\n### Registry\nAn external catalog service that conforms to the MCP registry specification at (https://registry.modelcontextprotocol.io/docs#/) that lists available MCP servers. Registries expose a REST API and are configured globally in Gram via the `mcp_registries` table. Currently, ALL registries are queried when users browse the catalog - there's no filtering. A registry lists information for discovering MCPs and advertises their configurations (and sometimes available tools, but they don't represent installable instances).\n\n**Desired changes:**\n* Registries often require header configuration - create relationship between environments and mcp_registries, modify registry_client to load environments and pass through keys as headers\n* Registry client should accept a cache and cache registry results locally (gram-zey)\n\n### External MCP Server\nA third-party MCP server listed in a registry. Identified by a `registry_server_specifier` (e.g., `io.github.user/server`). When added to a project, a registry is referenced via an `external_mcp_attachment` in a deployment, and then a proxy tool is generated inside of a source.\n\n### Source\nA virtual concept pointing to an external collection of tools with different rules for advertising the tools themselves, auth, and configuration. Has no concrete database entity - only referenced in the scope of a tool URN as a compound natural key: `(project_id, source_name)`.\n\n### Proxy Tool\nWhen an external MCP is processed, Gram creates a single proxy tool (`tools:externalmcp:\u003cslug\u003e:proxy`) that dynamically unfolds to the MCP's actual tools at runtime. This is a short-term solution to handle OAuth - most MCP actions are gated on Bearer token validation, and since Gram imports tools asynchronously, there's no \"correct\" token holder until tool _call_ time when the end user should be available to solve a challenge.\n\n**Goal changes:**\n* Short-term: evolve to read materialized tool lists from Registry metadata (gram-juu) - keep proxy tools as fallback since we can't rely on all registries having tool metadata\n* Standardize terminology: purge \"unfold\" language in favor of \"proxy\" (gram-y9k)\n\n### Toolset\nA curated collection of tools for a specific use case. Toolsets:\n- Belong to a **project** (via `project_id`)\n- Have versions tracking which tool URNs are included\n- Are automatically exposed as MCP servers at `/mcp/{mcp_slug}`\n- Can be public or private\n- Advertise Environment Variables that are dynamically resolved\n- Are the source of control for resolving OAuth Server metadata\n\n**Desired change:** Evolve the OAuth Server metadata relationship to be more explicit via a jump table. This ensures only a single OAuth server **per toolset** (rationale: toolsets have 1:1 relationship with resulting MCP servers, and each MCP server has a single OAuth configuration).\n\n### Deployment\nA versioned snapshot of a project's configuration including sources, external MCPs, and generated tools. External MCPs are added via `evolveDeployment`.\n\n### Project\nAn isolated workspace within an organization. Each project has its own deployments, toolsets, and external MCP attachments.\n\n**Desired change:** Projects should be more tightly involved in the user's workflow - they become the primary unit of curation and sharing for sub-catalogs.\n\n### Sub-Catalog\nWhile this term is used by our GTM team to describe a new product concept, it will **not be directly represented in the Gram system**. External consumers think of it as a partitioned set of servers connected to some externally advertised registry for specific teams with access control.\n\n**Implementation approach:** Rather than creating sub-catalogs as a new entity, we import desired catalog servers as toolsets into _projects_. We configure servers within projects, and use projects as units of sharing within an organization.\n\n### Gram Elements\n*(Deferred)* An embeddable chat interface that can interact with toolsets. Not in scope for MVP.\n\n---\n\n## Personae\n\n### Gram Tenant (e.g., Fivetran)\nThe organization in a business relationship with Speakeasy. Fivetran's aim is to offer product-embedded MCP that allows their customers to get more out of their data. As a data transport company, they have a specific need to help customers connect agents directly to many data destinations. We are design partnering with them.\n\nWithin a Gram Tenant, different stakeholders exist (admins, support, executives) - we'll clarify their perspectives as relevant to specific user stories.\n\n### Gram Sub-Tenant (e.g., Doordash)\nA customer of the Gram Tenant (Fivetran's customer). They receive access to a curated set of MCP servers through projects configured by the Tenant.\n\n### Gram Sub-Tenant User (e.g., Doordash Data Team Member)\nAn individual user within a Sub-Tenant organization. They:\n- See only the MCP servers curated for their project (not the full registry)\n- Install toolsets to their MCP clients\n- May or may not know they're using Gram, but ideally get some brand exposure\n\n### Gram Platform Admin\nInternal Speakeasy/Gram team member who:\n- Onboards enterprise partners\n- Configures initial setup\n- Manages registry configurations\n\n---\n\n## Value Delivery Requirements\n\nFor this epic to deliver complete value, the following must be true:\n\n### Primary: Project-Level Group Install Page (gram-3bn)\nOne of [Tenant Admin or Sub-Tenant User] needs to navigate to their project and see an obvious CTA for **installing the set of servers in that project as a collection of MCPs**.\n\nWe currently have `hosted_page.html.tmpl` which renders install buttons for a variety of clients (Cursor, Claude Code, Claude Desktop, VS Code, Gemini CLI, Codex CLI) for a **single toolset**. We need a scoped version that:\n- Takes a **group of toolsets** (all toolsets in a project)\n- Allows targeting a variety of clients\n- Provides a unified install experience\n\n---\n\n## User Stories\n\n### gram-z7p: Org-Permissioned Registry\n\n**As a** Gram Tenant (Fivetran)\n**I want to** develop a collection of external services relevant to my customers\n**So that** I can curate a Gram tenant for them to interact with relevant tools\n\n#### Acceptance Criteria\n- [ ] Tenant can identify a list of servers that will be published as a registry external to Gram\n- [ ] That registry can be permissioned directly to a given organization\n- [ ] Servers can easily be added to sub-projects\n\n#### Required System Changes\n- Create relationship between `mcp_registries` and `organizations`\n- Create relationship between `environments` and `mcp_registries`\n- Modify `registry_client` to load environments and pass through keys as headers\n\n---\n\n### gram-9vk: Tenant Admin Adds Servers to Project\n\n**As a** Tenant Admin (Fivetran Admin)\n**I want to** browse the MCP registry, select server groups, and add them to projects\n**So that** I can curate useful tools for specific Sub-Tenant teams\n\n#### Acceptance Criteria\n- [ ] Admin can search/browse the org-permissioned registry\n- [ ] Admin can select groups of servers as \"command cards\" and take actions on collections\n- [ ] Admin can select/create a project (named by team, e.g., \"Doordash Data Science\")\n\n#### Required System Changes\n- Dashboard allows selecting servers in groups as command cards and taking action as collections (progress exists in a branch)\n- Project selection raised to higher prominence in Gram information hierarchy\n\n---\n\n### gram-1x1: User Views Project Toolsets\n\n**As a** Sub-Tenant User (Doordash Data Team Member)\n**I want to** see the MCP servers available in my project\n**So that** I know what tools are available to me\n\n#### Acceptance Criteria\n- [ ] User navigates to their project and sees all toolsets configured for them\n- [ ] Each toolset shows its name, description, and available tools\n- [ ] User does NOT see the full registry - only project-scoped toolsets\n\n#### Required System Changes\n- Project landing page shows toolset summary cards\n- Toolset cards display tool counts and descriptions\n\n---\n\n### gram-3bn: Project-Level Group Install Page\n\n**As a** Sub-Tenant User\n**I want to** install all my project's toolsets to my MCP client (Cursor, Claude, etc.)\n**So that** I can use these tools in my AI workflows\n\n#### Acceptance Criteria\n- [ ] User sees prominent \"Install to Client\" CTA on project page\n- [ ] Clicking CTA opens install modal similar to existing hosted_page\n- [ ] Modal supports: Cursor, Claude Code, Claude Desktop, VS Code, Gemini CLI, Codex CLI\n- [ ] Install instructions work for **all toolsets in the project** as a group\n\n#### Required System Changes\n- Create project-level install page/modal (extends `hosted_page.html.tmpl` pattern)\n- Generate aggregated install commands for multiple toolsets\n- Handle multiple MCP server URLs in single install flow (all clients support multiple servers in one config)\n\n---\n\n### gram-1e2: Publish Project as Sub-Registry\n\n**As a** Gram Admin\n**I want to** publish a project's toolsets as an MCP registry\n**So that** I can fill gaps in available servers by publishing Gram Functions as MCP servers\n\n#### Acceptance Criteria\n- [ ] Admin can enable \"Publish as Registry\" on a project\n- [ ] Enabled projects serve a registry-compliant JSON at a predictable URL\n- [ ] Response includes PulseMCP-style annotations for compatibility\n- [ ] Registry can be consumed by other Gram instances or external clients\n\n#### Required System Changes\n- Add `registry_enabled` flag to projects (or similar affordance)\n- Add handler to `mcpregistries` package: `GET /{org}/{project}/v0.1/servers`\n- Handler serves registry-compliant JSON listing project's toolsets as servers\n- Include PulseMCP-compatible `_meta` annotations\n- Document the registry URL pattern for consumption\n\n---\n\n## Robustness Work\n\nThese items improve the reliability and quality of external MCP integration:\n\n### gram-y9k: Purge \"Unfold\" Language from Codebase\n\nReplace all \"unfold\" terminology with \"proxy\" for consistency.\n\n**Rationale:** The codebase uses both \"unfold\" and \"proxy\" to describe the same concept. Standardizing on \"proxy\" improves clarity and maintainability.\n\n**Changes:**\n- Search codebase for \"unfold\" references (variable names, comments, logs)\n- Replace with \"proxy\" equivalents\n- Update any documentation referencing \"unfold\"\n\n**Note:** This is a prerequisite for gram-juu to avoid introducing more inconsistent terminology.\n\n---\n\n### gram-juu: Materialize Tool Lists from Registry Metadata\n\nInstead of using proxy tools that expand at runtime, read materialized tool lists from registry metadata when available.\n\n**Rationale:** Improves tool discovery UX - users can see actual tools before calling them.\n\n**Depends on:** gram-y9k (terminology cleanup)\n\n**Changes:**\n- Extend registry client to parse tool metadata from registry responses\n- Store materialized tool definitions when available\n- Fall back to proxy tools when registry doesn't provide tool metadata\n\n---\n\n### gram-2ij: Proxy Headers from External MCP to Final MCP Config\n\nExternal MCP servers may advertise required headers. These need to flow through to the final MCP configuration.\n\n**Rationale:** Some MCP servers require specific headers (API keys, auth tokens) that need to be passed through.\n\n**Changes:**\n- Parse header requirements from external MCP server metadata\n- Include header configuration in generated MCP server config\n- Surface header requirements in install UI\n\n---\n\n### gram-e4x: OAuth Configuration Alerting\n\nImprove application alerting when OAuth configuration expansion fails or has issues.\n\n**Rationale:** OAuth misconfigurations are hard to debug - better alerting helps identify issues faster.\n\n**Changes:**\n- Add structured logging for OAuth discovery failures\n- Surface OAuth configuration errors in deployment status\n- Consider webhook/notification for OAuth issues\n\n---\n\n### gram-jbl: QA Pass on External MCP Servers\n\nRun a systematic QA pass on all external MCP servers currently available in the catalog.\n\n**Rationale:** Ensure quality and reliability of servers before promoting to enterprise partners.\n\n**Changes:**\n- Create QA checklist for external MCP servers\n- Test OAuth flows, tool execution, error handling\n- Document server reliability/compatibility status\n- Consider automated health checks\n\n---\n\n### gram-u1o: Improve External MCP Rendering in Client\n\nImprove how external MCPs render in the Gram dashboard.\n\n**Rationale:** Current rendering may be inconsistent or missing information.\n\n**Changes:**\n- Review and improve external MCP card components\n- Ensure consistent display of server metadata, icons, descriptions\n- Surface tool counts and capabilities more clearly\n\n---\n\n### gram-zey: Caching for Registry Results\n\nModify registry_client to accept a cache and cache registry results locally.\n\n**Rationale:** Reduces latency and load on external registries.\n\n**Changes:**\n- Add cache interface to RegistryClient\n- Implement in-memory or Redis-backed cache\n- Add cache TTL configuration\n- Consider cache invalidation strategy\n\n---\n\n## Open Questions (Answered)\n\n1. ~~Should sub-catalogs be a new entity or an extension of toolsets?~~ **Answered: Use projects as the unit of curation, toolsets within projects**\n2. ~~How do Sub-Tenant users authenticate?~~ **Direct Gram accounts**\n3. ~~How does the Tenant → Sub-Tenant → Project hierarchy map to Gram's current org model?~~ **Not represented in application/data model. Handled through business process. Only sub-tenant organization exists in system.**\n4. ~~What branding customization is needed on the project install page?~~ **None - users are in context of Gram dashboard**\n5. ~~For multi-toolset installs, do all clients support multiple MCP servers in one config?~~ **Yes, all support multiple**\n6. ~~What's the MVP scope for Gram Elements integration?~~ **Deferred - not in scope for now**\n\n---\n\n## Related Beads\n\nExisting work that feeds into this epic:\n- gram-9vk: Convert Catalog UI to Command Group\n- gram-zui: Add popover interface with Save To Project\n- gram-60v: Implement Sub Catalog Wizard\n- gram-six: Decide and implement CTAs for Sub-Catalog\n- gram-9zk: Add Catalog Logo Association with Toolsets\n\n---\n\n## Reference Documents\n\n- `.memory/REGISTRY.md` - MCP Registry specification and response structures\n","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2026-01-12T10:38:58.272584-08:00","created_by":"quinn","updated_at":"2026-01-20T10:50:44.74049-08:00","dependencies":[{"issue_id":"gram-9r1","depends_on_id":"gram-z7p","type":"blocks","created_at":"2026-01-20T10:34:36.622361-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-1x1","type":"blocks","created_at":"2026-01-20T10:34:36.686394-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-3bn","type":"blocks","created_at":"2026-01-20T10:34:36.73946-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-1e2","type":"blocks","created_at":"2026-01-20T10:34:36.793673-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-y9k","type":"blocks","created_at":"2026-01-20T10:34:47.035297-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-juu","type":"blocks","created_at":"2026-01-20T10:34:47.096597-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-2ij","type":"blocks","created_at":"2026-01-20T10:34:47.15291-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-e4x","type":"blocks","created_at":"2026-01-20T10:34:47.211396-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-jbl","type":"blocks","created_at":"2026-01-20T10:34:47.265098-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-u1o","type":"blocks","created_at":"2026-01-20T10:34:47.317665-08:00","created_by":"quinn"},{"issue_id":"gram-9r1","depends_on_id":"gram-q0p","type":"blocks","created_at":"2026-01-22T14:06:34.670823-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-9vk","title":"Convert Catalog UI to Command Group","description":"AGE-1126: Foundation for the catalog UI interaction pattern","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-12T10:39:57.148646-08:00","created_by":"quinn","updated_at":"2026-01-12T10:48:25.750956-08:00","dependencies":[{"issue_id":"gram-9vk","depends_on_id":"gram-9r1","type":"blocks","created_at":"2026-01-12T10:41:25.693887-08:00","created_by":"quinn"}]}
{"id":"gram-9zk","title":"Add Catalog Logo Association with Toolsets","description":"AGE-1130: Visual polish - catalog-backed toolsets render nicely","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T10:40:01.883523-08:00","created_by":"quinn","updated_at":"2026-01-12T10:40:01.883523-08:00","dependencies":[{"issue_id":"gram-9zk","depends_on_id":"gram-9r1","type":"blocks","created_at":"2026-01-12T10:41:25.909658-08:00","created_by":"quinn"},{"issue_id":"gram-9zk","depends_on_id":"gram-six","type":"blocks","created_at":"2026-01-12T10:41:34.765103-08:00","created_by":"quinn"}]}
{"id":"gram-c2g","title":"Use pulseMCP authOptions","description":"- Reconcile memory file with current state\n\n## Pre-merge checklist\n- [ ] Add back migration\n- [ ] Remove beads from source control\n- [ ] Remove this file","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-22T16:26:02.178523-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-22T16:27:45.915553-08:00"}
{"id":"gram-cpz","title":"Restore changes to allow renaming external-mcp sources","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-18T11:32:51.850839-08:00","updated_at":"2026-01-20T10:32:22.770485-08:00","closed_at":"2026-01-20T10:32:22.770485-08:00","close_reason":"Completed"}
{"id":"gram-d3x","title":"Port mise.toml secrets to use fnox","description":"Migrate the secrets configuration in mise.toml to use fnox for secret management instead of the current approach.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T11:36:34.757198-08:00","created_by":"quinn","updated_at":"2026-01-20T11:40:52.050245-08:00"}
{"id":"gram-drr","title":"Emit deployment failures to deployment logs","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-18T11:33:03.579405-08:00","updated_at":"2025-12-22T13:29:00.480854-08:00"}
{"id":"gram-e4x","title":"OAuth Configuration UX","description":"## Summary\n\nProvide clear visual language and affordances in the dashboard for OAuth configuration status on external MCP servers. Help users understand when OAuth is required, configured, or has issues.\n\n## Context\n\nExternal MCP servers may require OAuth authentication. When this is detected during deployment processing, we store OAuth metadata (version, endpoints, scopes). Users need to understand:\n- Which servers require OAuth\n- Whether OAuth is properly configured\n- What to do when configuration fails\n\n## UX Requirements\n\n### 1. OAuth Status Indicators\n\nVisual indicators on external MCP server cards/listings showing:\n- **No auth required** - Server works without authentication\n- **OAuth required** - Server needs OAuth, show setup CTA\n- **OAuth configured** - User has completed OAuth flow\n- **OAuth error** - Configuration issue needs attention\n\n### 2. OAuth Configuration Panel\n\nWhen viewing an external MCP that requires OAuth:\n- Display OAuth version (2.1 vs legacy 2.0)\n- Show authorization/token endpoints (collapsed by default)\n- Indicate supported scopes\n- CTA to initiate OAuth flow or re-authorize\n\n### 3. Error States\n\nClear messaging for OAuth failures:\n- **Legacy OAuth 2.0 detected** - \"This server uses legacy OAuth which requires manual client registration\"\n- **Discovery failed** - \"Could not discover OAuth configuration from server\"\n- **Token expired** - \"Re-authorize to continue using this server\"\n\n### 4. Install Flow Integration\n\nDuring install/configuration:\n- Flag servers that need OAuth setup\n- Guide users through OAuth flow before completing install\n- Show which headers/tokens will be configured\n\n## Design Considerations\n\n- Use consistent iconography for auth states (lock icons, checkmarks, warnings)\n- Avoid technical jargon where possible (\"Sign in with...\" vs \"Complete OAuth flow\")\n- Consider progressive disclosure - basic status visible, details on expand\n\n## Dependencies\n\n- gram-2ij: Header configuration must be in place for OAuth tokens to flow as Authorization headers\n\n## Acceptance Criteria\n\n- [ ] External MCP cards show OAuth status indicator\n- [ ] OAuth configuration panel displays relevant metadata\n- [ ] Clear error states with actionable messaging\n- [ ] Install flow surfaces OAuth requirements\n","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:28.625527-08:00","created_by":"quinn","updated_at":"2026-01-22T14:06:06.881326-08:00","labels":["triage"],"dependencies":[{"issue_id":"gram-e4x","depends_on_id":"gram-2ij","type":"blocks","created_at":"2026-01-21T11:07:15.479573-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-fl4","title":"Store MCP transport type (SSE vs Streamable HTTP)","description":"Store the transport type (SSE vs Streamable HTTP) on the tool record and invoke our client with the correct transport at call + list time.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T19:07:14.488806-08:00","updated_at":"2026-01-20T10:32:22.772066-08:00","closed_at":"2026-01-20T10:32:22.772066-08:00","close_reason":"Completed"}
{"id":"gram-jbl","title":"QA Pass on External MCP Servers","description":"Create QA checklist for external MCP servers. Test OAuth flows, tool execution, error handling. Document server reliability/compatibility status. Consider automated health checks.\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:33.197958-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:23.158157-08:00","labels":["triage"]}
{"id":"gram-jt9","title":"Allow proxy toolsets on install page","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-18T11:46:33.942201-08:00","updated_at":"2025-12-22T13:28:52.896355-08:00","closed_at":"2025-12-22T13:28:52.896355-08:00","close_reason":"Already completed"}
{"id":"gram-juu","title":"Materialize Tool Lists from Registry Metadata","description":"Extend registry client to parse tool metadata from registry responses. Store materialized tool definitions when available. Fall back to proxy tools when registry doesn't provide tool metadata.\n\nDepends on: R-0 (terminology cleanup)\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:19.789645-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:23.00023-08:00","labels":["triage"],"dependencies":[{"issue_id":"gram-juu","depends_on_id":"gram-y9k","type":"blocks","created_at":"2026-01-20T10:34:25.575667-08:00","created_by":"quinn"}]}
{"id":"gram-kjk","title":"Show deployment failure state in external MCP UI","description":"When external MCP deployment processing fails, the UI should indicate failure instead of showing success.\n\n## Current Behavior\n- UI shows 'view toolset' even when deployment fails\n- No indication to user that something went wrong\n\n## Desired Behavior\n- Show failure state in the UI when deployment processing fails\n- Replace 'view toolset' with 'view logs' navigation\n- Allow user to investigate what went wrong\n\n## Related\n- gram-n1k: deployment logs aren't populated for external MCP errors (fix that first so there are logs to view)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T18:31:01.780805-08:00","updated_at":"2026-01-20T10:32:22.773528-08:00","closed_at":"2026-01-20T10:32:22.773528-08:00","close_reason":"Completed","dependencies":[{"issue_id":"gram-kjk","depends_on_id":"gram-n1k","type":"blocks","created_at":"2025-12-18T18:32:05.122342-08:00","created_by":"daemon"}]}
{"id":"gram-mbw","title":"Extract source prefix parsing into shared utility","description":"## Context\nThe env var to header matching logic in `rpc_tools_list.go:unfoldExternalMCPTools` uses slug-based prefixing to match header definitions to their source.\n\n## Current Implementation\n```go\nslugPrefix := gateway.ToNormalizedEnvKey(tool_definition.Slug) + \"_\"\nfor _, def := range headerDefs {\n    defNameNormalized := gateway.ToNormalizedEnvKey(def.Name)\n    if !strings.HasPrefix(defNameNormalized, slugPrefix) {\n        continue\n    }\n    // ...\n}\n```\n\n## Problem\nThis prefix matching logic is inline and may need to be reused elsewhere (e.g., validation, UI display, other MCP operations).\n\n## Proposed Solution\nExtract into a shared utility in `gateway` or `conv` package:\n- `MatchesSourcePrefix(envVarName, sourceSlug string) bool`\n- `StripSourcePrefix(envVarName, sourceSlug string) string`\n- Consider also extracting the header resolution logic itself","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T21:19:09.37157-08:00","created_by":"quinn","updated_at":"2026-01-13T21:19:09.37157-08:00","labels":["ready"]}
{"id":"gram-n1k","title":"Make external MCP catalog production ready","description":"Production readiness improvements for external MCP catalog feature:\n\n## Deployment Logging\n- Errors from `doExternalMCPs` in process_deployment.go don't appear in deployment logs UI\n- `doExternalMCPs` only uses slog (application logs), never writes to `deployment_logs` table\n- Need to add `LogDeploymentEvent` calls similar to how `doOpenAPIv3` does it\n- Pattern to follow: `p.repo.LogDeploymentEvent(ctx, repo.LogDeploymentEventParams{...})`\n\n## Other Production Readiness Items\n- [ ] Add deployment logging for external MCP processing errors\n- [ ] Consider adding success/progress logs for external MCP attachment processing\n- [ ] Review error messages for user-friendliness\n\n## Context\nOpenAPI processing explicitly calls `tx.LogDeploymentEvent()` for errors, but external MCP processing only logs to slog which doesn't show up in the deployment logs UI that users see.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T18:27:29.965065-08:00","updated_at":"2025-12-22T13:40:38.520839-08:00","closed_at":"2025-12-22T13:40:38.520839-08:00","close_reason":"Duplicative of Gram Catalogue Preview Releases project"}
{"id":"gram-ph4","title":"Refactor client-side auth to use nginx-module-njs","description":"## Summary\nRefactor client-side authentication to use nginx's njs (JavaScript) module for session-to-token exchange at the edge, wrapping index.html requests.\n\n## Motivation\n- **Invariant properties**: Application code can assume sessions are always available — nginx guarantees this before requests reach the app\n- **Path-based auth gating**: Separate auth requirements by route at the nginx layer (some paths public, some require session, etc.)\n\n## Approach\nUse nginx-module-njs to:\n1. Intercept requests to index.html (and potentially other protected routes)\n2. Exchange session cookie with API server for auth token\n3. Handle failure cases:\n   - 401: Redirect to login\n   - 5xx: Return appropriate error page\n   - Network failures: Graceful degradation\n4. Set token cookie on successful exchange\n5. Serve index.html\n\n## Key Considerations\n- njs is NOT Node.js — custom nginx JS engine with limited ES6+ support\n- No npm packages available — must implement with njs built-ins\n- Available: ngx.fetch(), crypto module, querystring, basic JSON\n- If we need JWT libs or Redis, consider OpenResty/Lua or auth sidecar instead\n\n## Tasks\n- [ ] Audit current client-side auth flow\n- [ ] Design njs auth.js module\n- [ ] Configure nginx with js_import and js_content\n- [ ] Implement session exchange logic\n- [ ] Implement failure case handling (path-dependent)\n- [ ] Define path-based auth gating rules\n- [ ] Test with existing API server endpoints\n- [ ] Update deployment configs (Docker/k8s)\n- [ ] Document the new auth flow","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-20T10:51:44.894243-08:00","created_by":"quinn","updated_at":"2026-01-20T10:56:08.491479-08:00"}
{"id":"gram-pri","title":"Synchronize Adam's UX updates","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-21T10:32:55.297721-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-21T10:32:55.297721-08:00"}
{"id":"gram-q0p","title":"Canonical Environment Variable Name Helpers","description":"## Summary\n\nAdd helper functions to `gateway/env.go` for generating canonical environment variable names. Ensures consistent naming across the codebase when converting header names, source slugs, and other identifiers to environment variable format.\n\n## Context\n\nThe header configuration work (gram-2ij) introduces prefixed env var names like `SLACK_X_API_KEY`. Currently this uses `strcase.ToSNAKE()` inline. We should centralize this logic with clear helpers.\n\n## Proposed Helpers\n\n```go\n// gateway/env.go\n\n// CanonicalEnvKey returns a normalized env var key for lookups (lowercase).\n// Used when matching user-provided keys against expected keys.\nfunc CanonicalEnvKey(s string) string\n\n// EnvVarName returns a POSIX-compliant env var name (SCREAMING_SNAKE_CASE).\n// Used when generating env var names for display/config.\nfunc EnvVarName(s string) string\n\n// PrefixedEnvVarName returns \"{prefix}_{name}\" in canonical format.\n// Used for source-scoped env vars like \"SLACK_API_KEY\".\nfunc PrefixedEnvVarName(prefix, name string) string\n\n// HeaderToEnvVarName converts an HTTP header name to env var format.\n// \"X-Api-Key\" → \"X_API_KEY\"\nfunc HeaderToEnvVarName(header string) string\n```\n\n## Usage Sites\n\nAfter gram-2ij ships, refactor these locations to use the helpers:\n- `toolsets/shared.go` - header definition prefixing\n- `mv/toolset.go` - external MCP header extraction  \n- `gateway/proxy.go` - header value lookups\n- Any other env var name generation\n\n## Acceptance Criteria\n\n- [ ] Helper functions added to `gateway/env.go`\n- [ ] Unit tests for edge cases (dashes, special chars, unicode)\n- [ ] Existing inline `strcase` calls migrated to use helpers\n- [ ] Consistent naming across all env var generation\n","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-22T14:06:20.444396-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-22T14:06:20.444396-08:00","dependencies":[{"issue_id":"gram-q0p","depends_on_id":"gram-2ij","type":"blocks","created_at":"2026-01-22T14:06:28.054819-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-r7w","title":"Configure OAuth for Toolsets","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-18T11:31:53.326726-08:00","updated_at":"2025-12-18T11:31:53.326726-08:00","dependencies":[{"issue_id":"gram-r7w","depends_on_id":"gram-162","type":"blocks","created_at":"2025-12-18T11:33:37.395288-08:00","created_by":"daemon"},{"issue_id":"gram-r7w","depends_on_id":"gram-52s","type":"blocks","created_at":"2025-12-18T11:33:37.57129-08:00","created_by":"daemon"}]}
{"id":"gram-rtt","title":"Duplicate external MCP handling","description":"Handle duplicate external MCP entries gracefully.\n\nRequires us to make a project description for external MCPs.\n\nProduct consideration: It may make sense to make specific entries from registry unique per-project, but we would then inherit the project decision. Need to discuss with Chase.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T11:33:09.412462-08:00","updated_at":"2025-12-22T13:29:04.21529-08:00"}
{"id":"gram-six","title":"Decide and implement CTAs for Sub-Catalog User Journeys","description":"AGE-1129: Polish the user journey with proper CTAs","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T10:40:01.690765-08:00","created_by":"quinn","updated_at":"2026-01-12T10:40:01.690765-08:00","dependencies":[{"issue_id":"gram-six","depends_on_id":"gram-9r1","type":"blocks","created_at":"2026-01-12T10:41:25.85427-08:00","created_by":"quinn"},{"issue_id":"gram-six","depends_on_id":"gram-60v","type":"blocks","created_at":"2026-01-12T10:41:34.711752-08:00","created_by":"quinn"}]}
{"id":"gram-tly","title":"Tool names doubled in MCP install page","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-18T11:33:05.18553-08:00","updated_at":"2025-12-18T11:33:05.18553-08:00"}
{"id":"gram-u1o","title":"Improve External MCP Rendering in Client","description":"Review and improve external MCP card components. Ensure consistent display of server metadata, icons, descriptions. Surface tool counts and capabilities more clearly.\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:38.376275-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:23.209642-08:00","labels":["triage"]}
{"id":"gram-u3e","title":"Consolidate header merging logic in externalmcp/config.go","description":"## Motivation\n\nWe need to forward headers from system + user configuration to external MCPs for **both**:\n1. **Proxy tools** - runtime tool discovery via `ProxyToolExecutor`\n2. **Materialized tools** - pre-defined tools with known schemas\n\nThe header merging logic must be identical for both, so we need a shared implementation with a clean public interface.\n\n## The Bug\n\n**Current behavior in `ProxyToolExecutor.connect()`:**\n\nThe code filters system env by header definitions. Only env vars that have a matching header definition are considered.\n\n**Correct behavior:**\n\nSystem env values flow through **regardless of whether a header definition exists**. This matches the `doFunction` pattern where all system env is passed through.\n\n## Header Name Derivation\n\n- Without header definition: use `toolconfig.ToHTTPHeader(envVarName)` to derive header name\n- With header definition: use the definition's `HeaderName` field\n\n## Implementation\n\n1. Create `externalmcp/config.go` with `BuildHeaders(systemEnv, userConfig, headerDefs)` function\n2. Update `ProxyToolExecutor.connect()` to use `BuildHeaders`\n3. Same function will be used for materialized tool execution\n\n## Files\n- `server/internal/externalmcp/config.go` (NEW)\n- `server/internal/externalmcp/config_test.go` (NEW)\n- `server/internal/externalmcp/proxytoolexecutor.go` (UPDATE)","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-25T15:24:09.210058-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-25T16:16:34.32556-08:00","dependencies":[{"issue_id":"gram-u3e","depends_on_id":"gram-5uo","type":"blocks","created_at":"2026-01-26T11:50:40.218189-08:00","created_by":"Quinn Stearns"}]}
{"id":"gram-uwr","title":"Gracefully handle servers with both OAuth and API key auth","description":"## Context\n\nSome MCP servers (e.g., Stripe, GitHub) support both OAuth and API key authentication. The PulseMCP registry exposes this via the `authOptions` array:\n\n```json\n{\n  \"authOptions\": [\n    { \"type\": \"oauth\", \"detail\": { ... } },\n    { \"type\": \"api_key\", \"detail\": { \"sources\": [...] } }\n  ]\n}\n```\n\n## Problem\n\nGram needs to:\n1. Detect when a server supports multiple auth methods\n2. Allow users to choose their preferred method (or auto-select based on what credentials they have)\n3. Gracefully fall back if one method fails\n\n## Acceptance Criteria\n\n- [ ] Registry client parses all authOptions, not just the first\n- [ ] UI shows available auth methods when multiple exist\n- [ ] User can select preferred auth method\n- [ ] If OAuth token exists, prefer OAuth; otherwise fall back to API key\n- [ ] Handle edge case where user has both (let them choose)\n\n## Reference\n\nSee `.memory/REGISTRY.md` section on \"Dual Auth Support\" for examples.","status":"open","priority":2,"issue_type":"task","owner":"quinn@speakeasy.com","created_at":"2026-01-23T10:49:13.535678-08:00","created_by":"Quinn Stearns","updated_at":"2026-01-23T10:49:26.317329-08:00"}
{"id":"gram-w2s","title":"RFC: Convert Playground into full MCP client (or introduce OAuth solution)","description":"Write RFC exploring options for supporting external MCPs in the Playground. Options include converting the Playground into a full MCP client or introducing some other OAuth solution.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T13:41:05.277707-08:00","updated_at":"2026-01-20T10:32:33.108134-08:00","closed_at":"2026-01-20T10:32:33.108134-08:00","close_reason":"Won't do / out of scope"}
{"id":"gram-x07","title":"Add changes to properly respect WWW-Authenticate Header","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-18T11:32:56.669448-08:00","updated_at":"2025-12-22T13:28:52.894344-08:00","closed_at":"2025-12-22T13:28:52.894344-08:00","close_reason":"Already completed"}
{"id":"gram-y9k","title":"Purge Unfold Language from Codebase","description":"Replace all 'unfold' terminology with 'proxy' for consistency. Search codebase for unfold references (variable names, comments, logs). Replace with proxy equivalents. Update any documentation.\n\nThis is a prerequisite for R-1 (Materialize Tool Lists).\n\nSee gram-9r1 for full context.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-20T10:33:15.490072-08:00","created_by":"quinn","updated_at":"2026-01-20T10:48:22.949207-08:00","labels":["triage"]}
{"id":"gram-z7p","title":"Org-Permissioned Registry","description":"# Org-Permissioned Registry\n\nCreate relationship between mcp_registries and organizations. Modify registry_client to load credentials and pass through as headers.\n\nSee gram-9r1 for full context.\n\n---\n\n## Schema Changes\n\n### 1. Extend `mcp_registries`\n\n```sql\nALTER TABLE mcp_registries \nADD COLUMN visibility TEXT NOT NULL DEFAULT 'public',\nADD COLUMN credentials_encrypted TEXT;\n```\n\n- `visibility`: `'public'` (anyone can access) or `'private'` (org permission required)\n- `credentials_encrypted`: AES-256-GCM encrypted JSON blob containing HTTP headers\n  - Example plaintext: `{\"X-API-Key\": \"sk-xxx\", \"X-Tenant-ID\": \"fivetran-123\"}`\n  - Stored as base64-encoded ciphertext using existing `encryption.Client`\n\n### 2. New junction table `organization_registry_permissions`\n\n```sql\nCREATE TABLE IF NOT EXISTS organization_registry_permissions (\n  id uuid NOT NULL DEFAULT generate_uuidv7(),\n  organization_id TEXT NOT NULL,\n  registry_id uuid NOT NULL,\n  \n  created_at timestamptz NOT NULL DEFAULT clock_timestamp(),\n  updated_at timestamptz NOT NULL DEFAULT clock_timestamp(),\n  deleted_at timestamptz,\n  deleted boolean NOT NULL GENERATED ALWAYS AS (deleted_at IS NOT NULL) stored,\n  \n  CONSTRAINT organization_registry_permissions_pkey PRIMARY KEY (id),\n  CONSTRAINT organization_registry_permissions_organization_id_fkey \n    FOREIGN KEY (organization_id) REFERENCES organization_metadata (id) ON DELETE SET NULL,\n  CONSTRAINT organization_registry_permissions_registry_id_fkey \n    FOREIGN KEY (registry_id) REFERENCES mcp_registries (id) ON DELETE SET NULL\n);\n\nCREATE UNIQUE INDEX IF NOT EXISTS organization_registry_permissions_org_registry_key\nON organization_registry_permissions (organization_id, registry_id)\nWHERE deleted IS FALSE;\n```\n\n---\n\n## Query Logic\n\n**ListRegistriesForOrg(orgID)**\n\n```sql\nSELECT r.* FROM mcp_registries r\nWHERE r.deleted IS FALSE\n  AND (\n    r.visibility = 'public'\n    OR EXISTS (\n      SELECT 1 FROM organization_registry_permissions p\n      WHERE p.registry_id = r.id\n        AND p.organization_id = $1\n        AND p.deleted IS FALSE\n    )\n  );\n```\n\n---\n\n## Registry Client Changes\n\n1. Remove `RegistryBackend` interface (credentials come from DB now)\n2. Modify `RegistryClient.ListServers` and `GetServerDetails` to accept optional credentials map\n3. Apply credentials as HTTP headers when present\n\n```go\ntype RegistryClient struct {\n    httpClient *http.Client\n    logger     *slog.Logger\n    enc        *encryption.Client\n}\n\nfunc (c *RegistryClient) ListServers(ctx context.Context, registry Registry, params ListServersParams) ([]*types.ExternalMCPServer, error) {\n    // ... build request ...\n    \n    if registry.CredentialsEncrypted != nil {\n        headers, err := c.decryptCredentials(*registry.CredentialsEncrypted)\n        if err != nil {\n            return nil, fmt.Errorf(\"decrypt registry credentials: %w\", err)\n        }\n        for k, v := range headers {\n            req.Header.Set(k, v)\n        }\n    }\n    \n    // ... execute request ...\n}\n```\n\n---\n\n## Service Layer Changes\n\nUpdate `externalmcp.Service.ListCatalog` to:\n1. Get org ID from auth context\n2. Query registries using permission-aware query\n3. Pass decrypted credentials to registry client\n\n---\n\n## Implementation Checklist\n\n- [ ] Add `visibility` and `credentials_encrypted` columns to `mcp_registries`\n- [ ] Create `organization_registry_permissions` table\n- [ ] Generate migration with `mise db:diff`\n- [ ] Update sqlc queries for permission-aware registry listing\n- [ ] Refactor `RegistryClient` to accept credentials instead of backend\n- [ ] Update `ListCatalog` to filter by org permissions\n- [ ] Add tests for permission filtering\n- [ ] Add tests for credential header injection","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-20T10:32:52.226163-08:00","created_by":"quinn","updated_at":"2026-01-20T16:51:11.626804-08:00"}
{"id":"gram-zey","title":"Caching for registry results","description":"Modify registry_client to accept a cache and cache registry results locally.\n\n**Rationale:** Reduces latency and load on external registries. Currently every catalog browse hits the registry directly.\n\n**Changes:**\n- Add cache interface to RegistryClient\n- Implement in-memory or Redis-backed cache\n- Add cache TTL configuration\n- Consider cache invalidation strategy\n\nSee gram-9r1 Key Terms \u003e Registry for context.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-18T11:33:06.860335-08:00","updated_at":"2026-01-20T10:41:44.350562-08:00","labels":["triage"]}
{"id":"gram-zui","title":"Add popover interface with Save To Project and Build Sub Catalog","description":"AGE-1127: Core interaction pattern for saving servers","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-12T10:40:01.304111-08:00","created_by":"quinn","updated_at":"2026-01-12T10:40:01.304111-08:00","dependencies":[{"issue_id":"gram-zui","depends_on_id":"gram-9r1","type":"blocks","created_at":"2026-01-12T10:41:25.747384-08:00","created_by":"quinn"},{"issue_id":"gram-zui","depends_on_id":"gram-9vk","type":"blocks","created_at":"2026-01-12T10:41:34.604838-08:00","created_by":"quinn"}]}
