#!/usr/bin/env bash

set -e

# Parse command line arguments
agent_mode=false
auto_yes=false
for arg in "$@"; do
    case $arg in
        --agent)
            agent_mode=true
            shift
            ;;
        -y|--yes)
            auto_yes=true
            shift
            ;;
    esac
done

interactive_only() {
    if ! $agent_mode; then
        "$@"
    fi
}

onboarding_pass=true

# region: Onboarding checks

if [ ! -f "mise.local.toml" ]; then
    cat > mise.local.toml << EOF
# Local mise configuration
# This file is gitignored and can contain tools and environment variables
# that you personally need for local development.

[tools]
# Add your local tools here. Example:
# dive = "latest"

[env]
# Add your local environment variables here. Example:
# EXAMPLE_VAR = "value"
EOF
    echo "✅ Created mise.local.toml file"
fi

check_command() {
    local cmd=$1
    local instructions=$2

    if ! command -v "$cmd" &> /dev/null; then
        onboarding_pass=false
        
        echo "## \`$cmd\` not found:"
        echo "$instructions" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//'
        echo
    fi
}

# Install mise automatically in agent mode
if $agent_mode && ! command -v mise &> /dev/null; then
    echo "⏳ Installing mise..."
    curl -fsSL https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
    mise trust
else
    check_command "mise" "
    Install it from here: https://mise.jdx.dev/
    - Make sure to update your .zprofile (zsh), .profile (bash), ...
    - Additionaly enable completions for better DX: https://mise.jdx.dev/installing-mise.html#autocompletion
    "
fi


if ! $agent_mode; then
    check_command "docker" "
    Install it from here: https://www.docker.com/
    "
fi

if [ $onboarding_pass = "false" ]; then
    echo "❌ Onboarding checks failed. Please fix the issues above and rerun this script."
    exit 1
fi

# endregion: Onboarding checks

echo -e "\n⏳ Installing tools"
mise install

echo -e "\n⏳ Installing dependencies"
mise run install

echo -e "\n⏳ Setting up API keys and secrets"
interactive_only mise run zero:github
interactive_only mise run zero:openrouter
interactive_only mise run zero:melange
interactive_only mise run zero:fly
mise run zero:encryption
mise run zero:tls

echo -e "\n⏳ Building internal SDK"
mise run build:internal-sdk

echo -e "\n⏳ Updating VS Code and Cursor editor settings"
mise run install:vscode

echo -e "\n⏳ Starting infra"
interactive_only mise infra:start

echo -e "\n⏳ Running migrations"
mise run zero:migrations
mise db:migrate
mise clickhouse:migrate

interactive_only mise zero:summary

echo -e "\n✅ All set up!"

if $auto_yes; then
    exec mise run start
elif ! $agent_mode; then
    echo "Want me to start the server and dashboard (\`mise run start\`)?"
    echo -n "[y/N] "
    read -r answer
    answer=$(echo "$answer" | tr '[:upper:]' '[:lower:]')
    if [ "$answer" = "y" ]; then
    exec mise run start
    fi
fi
